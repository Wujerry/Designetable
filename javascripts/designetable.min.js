"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,t){var n=[],i=!0,l=!1,o=void 0;try{for(var r,s=e[Symbol.iterator]();!(i=(r=s.next()).done)&&(n.push(r.value),!t||n.length!==t);i=!0);}catch(a){l=!0,o=a}finally{try{!i&&s["return"]&&s["return"]()}finally{if(l)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();!function(){var e=(document.querySelectorAll.bind(document),document.querySelector.bind(document)),t=(Object.assign,"selected"),n="."+t;(function(){function i(t,n){var l=n.rows,o=void 0===l?5:l,r=n.columns,s=void 0===r?5:r,a=n.data,c=void 0===a?[]:a,u=n.renderTo,d=void 0===u?"body":u,v=n.cssNameSpace,h=void 0===v?"designetable":v;_classCallCheck(this,i),this.id=(new Date).getTime()+Math.floor(1e3*Math.random()),this.version="0.0.1",this.cssNameSpace=h,this.selector=t,this.rows=o,this.columns=s,this.data=c,this.container=e(d),this.element=e(t),this.contextMenu=null,this.startX=0,this.endX=0,this.startY=0,this.endY=0,this._mergedCell=[],this.selector&&e(this.selector)?this._refresh():this._init()}return _createClass(i,[{key:"_refresh",value:function(){}},{key:"_init",value:function(){this.element=this._createTable(),this._bindEvent(),this.container&&this.container.appendChild(this.element)}},{key:"_bindEvent",value:function(){this._bindSelection(),this._bindContextMenu(),this._bindDragSize()}},{key:"_bindDragSize",value:function(){var e=this,t=void 0,n=void 0,i=void 0,l=void 0,o=void 0,r=void 0,s=void 0,a=void 0,c=void 0,u=function(t,n,i){var l=document.createElement("div"),o=document.createElement("div");return l.classList.add("dt-line-"+n),o.classList.add("dt-line-"+n+"-origin"),"v"===n?(l.style.left=t.clientX-i.left+"px",o.style.left=t.clientX-i.left+"px"):(l.style.top=t.clientY-i.top+"px",o.style.top=t.clientY-i.top+"px"),e.element.appendChild(l),e.element.appendChild(o),[l,o]},d=function(){if("v"===l)for(var i=r+(parseInt(n.style.left)-parseInt(o.style.left))+"px",a=t.parentElement.cellIndex,c=0,u=e.element.rows.length;c<u;c++)e.element.rows[c].cells[a].style.width=i;else for(var d=s+(parseInt(n.style.top)-parseInt(o.style.top))+"px",v=t.parentElement.parentElement,h=0,f=v.cells.length;h<f;h++)v.cells[h].style.height=d},v=function(e){"v"===l?a<e.clientX||a-e.clientX<r?n.style.left=e.clientX-i.left+"px":n.style.left=a-r-i.left+1+"px":c<e.clientY||c-e.clientY<s?n.style.top=e.clientY-i.top+"px":n.style.top=c-s-i.top+1+"px"},h=function m(t){e.element.removeEventListener("mousemove",v,!1),document.removeEventListener("mouseup",m,!1),d(t),n.remove(),o.remove()},f=function(d){if("SPAN"===d.target.tagName){t=d.target,i=e.element.getBoundingClientRect(),t.classList.contains("v")&&0===d.button?(l="v",a=d.clientX,r=parseInt(e.getComputedStyle(t.parentElement,"width"))):t.classList.contains("h")&&(l="h",c=d.clientY,s=parseInt(e.getComputedStyle(t.parentElement,"height")));var f=u(d,l,i);n=f[0],o=f[1],e.element.addEventListener("mousemove",v),document.addEventListener("mouseup",h)}};this.element.addEventListener("mousedown",f)}},{key:"_bindContextMenu",value:function(){var e=this,t=e.element,n=e._getContextMenuConfig(),i=void 0,l=void 0,o=void 0,r=void 0,s=void 0,a=void 0,c=void 0,u=function(e,t){var n=e.srcElement||e.target;if(n.classList.contains(t))return n;for(;n=n.parentNode;)if(n.classList&&n.classList.contains(t))return n;return!1},d=function(){var e=0;return n.reduce(function(t,n){var i="";return n.children&&!function(){var t=0;i='<ul class="child-ul">'+n.children.reduce(function(i,l){return i+('<li data-i="'+e+'" data-id="'+(n.id||"")+'" data-ic="'+t++ +'">'+l.name+"</li>")},"")+"</ul>"}(),t+('<li data-i="'+e++ +'" data-id="'+(n.id||"")+'" class="context-li">'+n.name+i+"</li>")},"")},v=function(t){var n=e.contextMenu;i=e.getPosition(t),l=i.x,o=i.y,r=n.offsetWidth+2,s=n.offsetHeight+2,a=window.innerWidth,c=window.innerHeight,a-l<r?n.style.left=a-r+"px":n.style.left=l+"px",c-o<s?n.style.top=c-s+"px":n.style.top=o+"px"},h=document.createElement("ul");h.id=e.id+"cm",h.classList.add("dt-context-menu"),h.innerHTML=d(),document.body.appendChild(h),e.contextMenu=h;var f=function(t){t.preventDefault(),v(t),e._toggleContextMenu(!0)};t.addEventListener("contextmenu",f),document.addEventListener("mousedown",function(t){u(t,"context-li")||e._toggleContextMenu(!1)}),h.addEventListener("click",function(t){var i=t.target;if("LI"===i.tagName){var l=i.dataset.i,o=i.dataset.ic;e._toggleContextMenu(!1),o?n[l].children[o].fn&&n[l].children[o].fn(t):n[l].fn&&n[l].fn(t)}})}},{key:"_bindSelection",value:function(){var e=this,t=this,n=t.element,i=[],l=function(e,t){return(e^t)>-1},o=function(e,t){return[t[0]-e[0],e[1]-t[1]]},r=function(e,t){return[e[0]+t[0],e[1]-t[1]]},s=function(e,n,i){return i.colSpan>1&&e>=t.startX&&(e=e+i.colSpan-1),i.rowSpan>1&&n>=t.startY&&(n=n+i.rowSpan-1),[e,n]},a=function(e){return e>-1?++e:--e},c=function(e,n){var s=[t.startX,t.startY],c=i[i.length-1],u=o(s,c),d=[e,n],v=o(s,d),h=function(){t.removeSelectedClassByPoint(c,r(s,[0,a(v[1])]))},f=function(){t.removeSelectedClassByPoint(r(s,[a(v[0]),v[1]]),r(s,[u[0],0]))};if(i.push(d),l(u[0],d[0])&&l(u[1],v[1])){var m=u.map(function(e){return Math.abs(e)}),y=v.map(function(e){return Math.abs(e)});y[0]>=m[0]&&y[1]>=m[1]?t.addSelectedClassByPoint(s,d):y[0]<=m[0]&&y[1]<=m[1]?u[0]===v[0]?h():u[1]===v[1]?f():(h(),f()):y[1]<m[1]?(h(),t.addSelectedClassByPoint(d,r(s,[a(u[0]),0]))):(t.removeSelectedClassByPoint(c,r(s,[a(v[0]),0])),t.addSelectedClassByPoint(d,r(s,[0,a(u[1])])))}else t.clearSelected(),t.addSelectedClassByPoint(s,d)},u=function(e){if("TD"===e.target.tagName){e.preventDefault();var n=e.target,l=i[i.length-1],o=n.cellIndex,r=n.parentElement.rowIndex;if(l[0]!==o||l[1]!==r){var a=s(o,r,n);t.endX=a[0],t.endY=a[1],c(a[0],a[1])}}},d=function h(){n.removeEventListener("mousemove",u,!1),document.removeEventListener("mouseup",h)},v=function(l){if("TD"===l.target.tagName&&0===l.button){e.clearSelected(),e.clearStart();var o=l.target;t.startX=t.endX=o.cellIndex,t.startY=t.endY=o.parentElement.rowIndex,i.length=0,i.push([t.startX,t.startY]),t.addSelectedClass(o),o.classList.add("start"),n.addEventListener("mousemove",u),document.addEventListener("mouseup",d)}};n.addEventListener("mousedown",v)}},{key:"_createTable",value:function(){var e=document.createElement("table");return e.classList.add(this.cssNameSpace),this.data.length||(e.innerHTML=this._createRows(this.columns,this.rows).join("")),e}},{key:"_createEls",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"td":arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return new Array(t).fill(0).map(function(t){return"<"+e+'><span class="v"></span><span class="h"></span></'+e+">"})}},{key:"_createRows",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return new Array(n).fill(0).map(function(n){return"<tr>"+t._createEls("td",e).join("")+"</tr>"})}},{key:"_calPoint",value:function(e,t){return[[Math.min(e[0],t[0]),Math.min(e[1],t[1])],[Math.max(e[0],t[0]),Math.max(e[1],t[1])]]}},{key:"_handleSelectedClassByPoint",value:function(e,t,n){for(var i={add:"addSelectedClass",remove:"removeSelectedClass"},l=this._calPoint(t,n),o=_slicedToArray(l,2),r=o[0],s=o[1],a=r[1],c=s[1]+1;a<c;a++)for(var u=r[0],d=s[0]+1;u<d;u++)this[i[e]](this.getTdByPoint(u,a))}},{key:"_toggleContextMenu",value:function(e){this.contextMenu&&(e&&this._BeforeContextMenu(),this.contextMenu.classList.toggle("show",e))}},{key:"_BeforeContextMenu",value:function(){this._isMergedCellInsideSelection()?(this.contextMenu.querySelector("[data-id=mc]").style.display="block",this.contextMenu.querySelector("[data-id=umc]").style.display="none"):(this.contextMenu.querySelector("[data-id=mc]").style.display="none",this.contextMenu.querySelector("[data-id=umc]").style.display="block")}},{key:"_getContextMenuConfig",value:function(){var e=this;return[{name:"Merge cells",id:"mc",icon:"copy",fn:function(t){e.mergeCells(t)}},{name:"UnMerge cells",id:"umc",icon:"copy",fn:function(t){e.unMergeCells(t)}},{name:"Copy",icon:"copy"},{name:"Paste",icon:"paste"},{name:"Parent",icon:"parent",children:[{name:"child"}]}]}},{key:"_isMergedCellInsideSelection",value:function(){var e=this;return this._mergedCell.length,this._mergedCell.every(function(t){return!e._isCellInSelection(t)})}},{key:"_isCellInSelection",value:function(e){return e[0]>=this.startX&&e[0]<=this.endX&&e[1]>=this.startY&&e[1]<=this.endY}},{key:"getComputedStyle",value:function(e,t){return window.getComputedStyle(e,null).getPropertyValue(t)}},{key:"unMergeCells",value:function(){var e=this,t=[];this._mergedCell.filter(function(n){return!!e._isCellInSelection(n)||(t.push(n),!1)}).forEach(function(t){for(var n=e.getTdByPoint(t[0],t[1]),i=t[1],l=i+n.rowSpan;i<l;i++)for(var o=t[0],r=o+n.colSpan;o<r;o++)e.getTdByPoint(o,i).style.display="table-cell";n.rowSpan=n.colSpan=1}),this._mergedCell=t}},{key:"mergeCells",value:function(){if(this._isMergedCellInsideSelection()&&!this.isEqualPoint()){var e=this._calPoint([this.startX,this.startY],[this.endX,this.endY]),t=_slicedToArray(e,2),n=t[0],i=t[1],l=this.getTdByPoint(n[0],n[1]);l.colSpan=i[0]-n[0]+1,l.rowSpan=i[1]-n[1]+1;for(var o=n[1],r=i[1];o<=r;o++)for(var s=n[0],a=i[0];s<=a;s++)this.getTdByPoint(s,o).style.display="none";l.style.display="table-cell",this._mergedCell.push([n[0],n[1]])}}},{key:"isEqualPoint",value:function(e,t){return e&&t?!(e[0]!==t[0]||e[1]!==t[1]):this.startX===this.endX&&this.startY===this.endY}},{key:"getPosition",value:function(e){var t=0,n=0;return e||(e=window.event),e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:t,y:n}}},{key:"addSelectedClassByPoint",value:function(e,t){this._handleSelectedClassByPoint("add",e,t)}},{key:"removeSelectedClass",value:function(e){e.classList.remove(t)}},{key:"removeSelectedClassByPoint",value:function(e,t){this._handleSelectedClassByPoint("remove",e,t)}},{key:"clearSelected",value:function(){this.element.querySelectorAll(n).forEach(function(e){return e.classList.remove(t)})}},{key:"clearStart",value:function(){this.element.querySelectorAll(".start").forEach(function(e){return e.classList.remove("start")})}},{key:"getTdByPoint",value:function(e,t){return this.element.rows[t]?this.element.rows[t].cells[e]:this.element}},{key:"addSelectedClass",value:function(e){e.classList.add(t)}},{key:"destroy",value:function(){document.querySelectorAll(".dt-context-menu").forEach(function(e){return e.remove()})}},{key:"logOption",value:function(){console.log(this.options)}},{key:"version",value:function(){console.log(this.version)}}]),i})()}();